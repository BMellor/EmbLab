

\documentclass[11pt,fleqn]{book} % Default font size and left-justified equations

\input{structure} % Insert the commands.tex file which contains the majority of the structure behind the template
\usepackage{float}

\usepackage{listings} 
\lstset
{ 
    language=C,
    basicstyle=\ttfamily,
    columns=fullflexible,
    keepspaces=true,
    numbers=none,
    stepnumber=1,
    showstringspaces=false,
    tabsize=1,
    breaklines=true,
    breakatwhitespace=false,
    keywordstyle=\color{blue!80!black},
    stringstyle=\color{red!80!black},
    commentstyle=\color{green!40!black},
    morecomment=[l][\color{magenta!80!black}]{\#}
}

\usepackage{caption}
\captionsetup[figure]{font=small,skip=10pt}

%\usepackage{enumitem}
%\setlist{noitemsep} % or \setlist{noitemsep} to leave space around whole list


%%%%% May be too harsh to prevent paragraph breaks across pages! 
%\interlinepenalty 10000
\widowpenalties 1 10000
\raggedbottom


\newcommand{\ilcode}[1]{
    %\vspace{0.5pt}
    \smallskip
    \colorbox{gray!20!white}{
        \centering
        \parbox{\linewidth-2\fboxsep}{
            \lstinline@#1@
        }
    }
    %\vspace{0.5pt}
}

\newcommand{\code}[3]{
    \begin{figure}[]
        \colorbox{gray!20!white}{
            \parbox{\linewidth-2\fboxsep} {
                \centering 
                \lstinputlisting[language=C]{#1}
            }
        }
        \caption{#2}
        \label{#3}
    \end{figure}
}


%\begin{figure}[]
%    \centering\includegraphics[width=0.75\textwidth]{}
%    \caption{}
%    \label{}
%\end{figure}

\usepackage{textcomp}
\usepackage{wrapfig}
\usepackage{float}

\usepackage{silence} % http://ctan.org/pkg/silence
\ErrorFilter{textcomp}{Symbol \textrightarrow not provided}

% Disable paragraph indentation globally since template was indenting some and not others. (looked terrible)
\setlength{\parindent}{0pt}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%                                                                                         %%%%
%%%%       Chapter 4: Timers, PWM and GPIO Alternate Functions                               %%%%
%%%%                                                                                         %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\setcounter{chapter}{3} % Manually adjust chapter counter to number before desired chapter heading

\begin{document}
	
\chapterimage{chapter_head_2.png} % Chapter heading image
\chapter{Timers, PWM and GPIO Alternate Functions}

\section{Introduction to Timers}
The last lab used the SysTick timer to generate a periodic interrupt. The SysTick is a simple peripheral with a 24-bit down-counting counter that triggers an interrupt as it reaches zero. The primary purpose of the SysTick timer is to generate a stable system ``tick'' or heartbeat/timing reference signal. 

this heartbeat signal is used to signal the passage of a unit of time. Some common places where the SysTick is used is in the HAL delay libraries and in the context switcher of real-time operating systems. 

Why is getting accurate timing so important? Truth is it's hard and inefficient to measure time simply by the processor without some sort of dedicated hardware like a timer. 

Timers are at their core simply a register the increments or decrements whenever a trigger signal occurs. Upon this are built the capability to generate hardware interrupts, like the SysTick. However, the SysTick is the simplest of the on-board timer peripherals.

%    Why have timer circuits?
%        SysTick timer
%            last lab modified its interrupt
%            simple down-counter, generates ISR when hit zero
%            used to create fixed-time periodic interrupts
%        Hard and inefficient to measure time with only instruction count
%        Have hardware to count processor or other clock source in the chip
%        Means you can measure time to schedule operations
    
    \subsection{Systick vs Peripheral Timers}
     Because the SysTick peripheral has a very simple purpose, to generate periodic interrupts, it doesn't offer any features that make it useful for more complicated tasks. 
     
     Unlike the SysTick, peripheral timers within the STM32F0 are designed to be useful in whatever tasks the user application can come up with. Because of this they are fairly complicated devices with a large variety of features. Figure \ref{block_timers} shows the block diagram for general-purpose timers 2 \& 3 in the STM32F072.     
%        The SysTick is very limited, mainly used for just a timebase (Delay libraries, RTOS scheduler etc...)
%        The peripheral timers of the STM32F0 have more advanced capabilities than generating simple interrupts when they reload their value. 
%        
%        (Block diagram of timer 2 \& 3)
        \begin{figure}[]
            \centering\includegraphics[width=\textwidth]{block_timers}
            \caption{Block diagram of timers 2 \& 3}
            \label{block_timers}
        \end{figure}
        
        The three main features that peripheral timers offer over simpler devices such as the SysTick are:
        \begin{enumerate}
            \item \textbf{Selectable and Prescalable Clock Sources} -- Many peripheral timers can use multiple signals as clock sources and can divide the input frequency by arbitrary integer values. 
            \item \textbf{Generate Interrupts at Multiple Conditions} -- Many Peripheral timers can generate interrupts at arbitrary counter values.
            \item \textbf{Directly Modify GPIO Pins} -- Many peripheral timers can directly set or capture GPIO pin states to measure or generate digital signals.  
        \end{enumerate}
        
%        Here are a few basic features:
%            Selectable and prescalable clock sources
%                The timers have built-in frequency dividers (prescaler) to reduce the input clock signal so they can count at more arbitrary rates. 
%            Generate interrupts at multiple conditions 
%                Can generate interrupts on top, bottom or even arbitrary counter values. 
%                These are selected by the different modes of operation that the timer can be placed into. 
%        Ability to directly modify some GPIO pin outputs without requiring an interrupt. Used mainly for waveform generation. (capture-compare, PWM)
%        Can directly read some GPIO input pins to measure the time between changes. (input capture)	
    
    \subsection{Timers in the STM32F072}
        %(Show table of timers in the STM32F072)
        \begin{figure}[]
            \centering\includegraphics[width=\textwidth]{avaliable_timers}
            \caption{STM32F072RB hardware timers}
            \label{avaliable_timers}
        \end{figure}
        
        
        Figure \ref{avaliable_timers} shows the timers available in the STM32F072 chip we are using. When deciding on a timer to use for an application, it is helpful to understand their capabilities and if they are suitiable for the task. A brief breakdown of the information in figure \ref{avaliable_timers} is as follows:
        
        \begin{itemize}
            \item \textbf{Timer Type} -- There are multiple classes of timers within the STM32F0. These serve as indicators of the appropriate uses for the peripheral. An advanced control timer offers additional and more-complex operating modes than a general-purpose one. 
            \item \textbf{Timer} -- These abbreviated names are used to identify between timers in the documentation. They are also the defined names for the timer structures in the supporting peripheral header files. 
            \item \textbf{Counter Resolution} -- This indicates how large the hardware counter within the timer is. A 16-bit timer can only count to $2^{16}$ values before overflowing and wrapping back to zero. 
            \item \textbf{Counter Type} -- Typically the hardware counter in a timer counts upwards with each clock cycle. However, more advanced timers can also be set to count downwards from a value, or to automatically change direction whenever reaching the limit values. 
            \item \textbf{Prescaler Factor} -- The prescale factor allows the timer to pre-divide the input clock to a slower frequency. The timers within the STM32F0 have the ability to divide the input clock by arbitrary integer factors between 1 and $2^{16}$.
            \item \textbf{DMA Request Generation} -- Many peripherals have the ability to move data between peripheral registers and system memory without using the main processor. This process is called direct memory access (DMA).
            \item \textbf{Capture/Compare Channels} -- Most timers have the ability to directly modify GPIO pins without using the GPIO peripheral. The capture/compare system in a timer is used to generate and measure digital signals on an external pin. 
            \item \textbf{Complimentary Outputs} -- Some capture/compare circuity has the ability to generate complimentary or opposite outputs on GPIO pins. This generates an effect similar to differential signaling 
        \end{itemize}
        
        
%        Discuss basic features: (BRIEFLY!)
%            Timer Type
%            Counter resolution/size
%            Counter Type
%            Prescaler
%            DMA Request
%            Capture/compare channels
%            Complimentary outputs
%    

\section{Using the Timer Documentation}
    At this point the peripherals that the labs are going to be discussing are going to be reaching the level of complexity that the lab manuals are not going to be able to provide enough documentation to complete the lab assignments without additional reading in the datasheets and peripheral reference manual. 
    
    Instead the lab manual will provide an overview of the different modes of operation of the peripheral And provide some insight as to what registers are important in that mode. the assignment will provide meaningful steps to accomplish the end goal. 

    In figure \ref{avaliable_timers} we discussed the characteristics of the available timers in the STM32F072. For the remainder of this lab manual we will be focusing on the documentation materials for TIM2 \& TIM3. 
    
    Timers 2 \& 3 are the more-advanced versions of the general purpose timers in the STM32F0. They have a nearly identical interface as the simpler timers, except that they feature additional configuration options and more output channels. By reading through the documentation of these timers, you should be able to move to one of the simpler devices without trouble in the assignment 
    
    \subsubsection{Organization of Peripheral Documentation}
    The each section of the peripheral reference manual follows a similar organization when documenting a peripheral. 
    
    
%##    The timer peripherals in the STM32F0 are complex, it isn't possible to document them in the lab manual
%##    MUST get familiar with searching the peripheral reference manual
%##    For these sections will be using the documentation on timers 2\&3 
%##        They're not super simple timers, but not the advanced one either
%        Their documentation is 65 pages long... (and dense)
%    
%    Reference manual documentation goes in this format:
%        Basic information on what peripheral does
%        Details and architectural block diagrams
%        Documentation of the different modes
%        These usually have some specific background info
%        Summarized information on how to configure the mode
%            Gives generic steps, will need to carefully read the register documentation
%        Summarized information on data produced 
%            describe where produced data is written
%            Includes figures depicting operation
%    
%    This manual will document the purpose of the base registers as they are used in each mode
%        May also indicate groups of control bits that pertain to the configuration or operation 	

\section{Using Timers to Generate Interrupts and Events}

    One of the most basic uses of a timer is to generate periodic interrupts. Unlike the SysTick timer which is typically configured once and to a specific base unit of time, the peripheral timers are available to use for arbitrary timing periods and can be used as event counters when using alternate signals as clock sources. Because their input prescaler can be used to divide the input clock by arbitrary integer values, it is possible to generate very long timer periods or match strange timing requirements that aren't multiples of the system clock. Section 18.3 \textit{TIM2 and TIM3 Functional Description} of the peripheral reference manual documents the following in greater detail. 

    There are three registers that form the basic operations of a timer peripheral. 
    \subsubsection{TIMx\_CNT -- Timer Counter Register}
    The CNT register holds the current value of the counter in the timer. Its size depends on the counter resolution (16/32-bit) indicated in the timer's documentation. Athough this register is automatically updated as the timer operates, it is possible to manually read and edit its value. The CNT register can be read within the main application loop as a method of counting time, or written in order to modify the timer's operation. 
    \subsubsection{TIMx\_PSC -- Timer Prescaler Register}
    The PSC register is used to divide the input clock frequency to the timer. It's value is 0-indexed meaning that a value of 0 in the PSC register divides the clock source by 1. (no frequency scaling) Likewise a value of 1 in the PSC register divides the clock source by 2 and causes the timer to count at half the clock frequency. The PSC can divide the input clock by any integer value that will fit in its 16-bit width. 
    \subsubsection{TIMx\_ARR -- Timer Auto-Reload Register}
    Although a timer has a physical hardware size to its counter register, it is possible to set an artificial top limit. The value in the ARR register is the trigger point where the timer resets and begins to count a new period. The actual behavior of the timer depends on its counting mode and will be discussed more in a later section. 
%    These timer modes make use of the basic time-base unit of the timer. 
%    This portion does what you'd expect from the timer (it counts)
    
    \subsection{Basic Timer Operation}
    
    There are three different counting modes that the timers can operate under: up, down, and center-aligned (up/down). Note that all but three of the hardware timers in the STM32F072 are only upcounters. Figure \ref{count_modes} shows a graphical representation of the counting modes. 
    
    \begin{itemize}
        \item \textbf{Upcounting Mode} --  In upcounting mode, the timer starts at 0 and counts upwards to the auto-reload value in the TIMx\_ARR register. After reaching the ARR limit the counter resets back to 0. 
        \item \textbf{Downcounting Mode} -- In downcounting mode, the timer starts at the auto-reload value and counts downwards until reaching 0. After reaching the lower limit it resets back to the ARR value.
        \item \textbf{Center-aligned Mode (up/down counting)} -- In center-aligned mode, the timer starts by counting upward from 0 until the auto-reload value. Once the upper limit is reached, the counting direction reverses and the timer counts downwards towards zero.
    \end{itemize}

    
    
%   % Basic registers used in these modes (not including control/setup registers)
%%        timer counter
%%        prescaler 
%%        auto-reload
%        
%        control registers   ################### Suggest what each register does, for example enable timer in CR1
%        CR1 \& CR2
%        DIER
%        SR
%        
%    
%    up, down, up/down (center-aligned) counting modes
    
    %(combination figure showing sawtooth/triangle waves for counter value)
    \begin{figure}[]
        \centering\includegraphics[width=\textwidth]{count_modes}
        \caption{Timer counting modes and update interrupts}
        \label{count_modes}
    \end{figure}
    
    \subsubsection{Basic Timer Interrupts}
    
    Regardless of the counting mode used, whenever the timer reaches a limit and is reset to a new value is called an \textit{Update Event} (UEV). Additionally, center-aligned counters can be configured to trigger update events whenever the timer changes to a specific direction. 
    
    The UEV is one of the possible interrupt sources in a peripheral timer. Typically this interrupt source is used to generate periodic interrupts, but with a very flexible and potentially long duration period. 
    
    
    \subsubsection{Configuring Basic Timer Settings}
    In addition to the three main timer registers, there are four control registers used to set timer parameters. These are used to enable the timer, set the counting direction, enable the UEV interrupt, and clear the pending interrupt flag in a handler. 
    
    \begin{itemize}
        \item \textbf{TIMx\_CR1 \& CR2} -- Control Registers 1 \& 2 hold the crucial configuration options of the timer. For example, before the timer can operate it must be enabled using the \textit{Counter Enable} (CEN) bit. 
        \item\textbf{TIMx\_DIER} -- The DMA/Interrupt Enable Register controls the possible interrupt sources in the timer.
        \item\textbf{TIMx\_SR} -- The Status Register contains pending flags that must be cleared in interrupt handlers.
    \end{itemize}
    %control registers   ################### Suggest what each register does, for example enable timer in CR1
    %        CR1 \& CR2
    %        DIER
    %        SR
    
    
%    UEV - Update event, occurs when the counter value is reset by hardware
%        this can happen at counter overflow/underflow
%        whenever the timer is reset to 0 because it reached the ARR value
%        whenever the timer changes direction (center aligned mode)
%    Other interrupts are generated by the capture/compare system
    
    \subsection{Selecting Timer Frequency and Interrupt Period}	
    choosing a frequency the timer runs at (keep BRIEF)
    selecting a clock source
        internal clock, selected by the clocking system when configuring the project (most used)
        external clock pin for timer
            works on a configurable edge like the EXTI external interrupts
        Internal trigger inputs
            These signals can connect multiple peripherals together
            Used to chain timers together, or count events generated by other types of peripherals
    
    \subsubsection{Using the Prescaler}
        remember that it's 0-biased so subtract 1 from the desired divider
        (prescaler of 1 divides frequency by half)
    
    \subsubsection{Calculating Register Values}
        calculating the timer ARR and prescaler values from a desired interrupt period 
        	
        \begin{example}[Calculating ARR and PSC Values] 
                Example: Do a calculation for an arbitrary period, perhaps multiple ways to do the same. 
        \end{example}
    

\section{Using Timers to Generate or Measure Signals}
    These modes all use the capture/compare circuity of the timer
    Brief overview of the capture/compare unit
    
    The mode of operation of the capture/compare unit is set by the 3 capture/compare mode registers. (CCMR1-3)				
    
    \subsection{Input Capture Mode}
        Keep brief, not focus of lab
        Basic theory and graphical example		
        Simple use-cases: stopwatch, tracking motor speed using a click-wheel
            will be using a fancy version of input capture mode (quadrature encoder mode) to track speed and direction of the motor in later labs.
        Counter value saved in the capture/compare register (CRR)
    
    \subsection{Output Compare Mode}
        Output compare mode uses an extra control register CCR
        The timer operates like normally with the counter and ARR but a capture/compare interrupt/event occurs whenever the timer counter reaches the value in the CCR.
        
        The capture/compare unit can directly modify the output of a pin on this compare event
        What happens to the pin (set-high, set-low, toggle) depends on the mode in the control register. 
        
        (figure of edge-aligned toggle on match )
        \begin{figure}[]
            \centering\includegraphics[width=\textwidth]{ocomp_mode}
            \caption{Output Compare mode with pin toggle on compare match.}
            \label{ocomp_mode}
        \end{figure}
    
        The capture compare mode register can be changed on-the-fly, moving the event point. This is often used in PWM mode.
    
    \subsection{Pulse-Width Modulation (PWM) Mode}
    What is PWM?
    What is it used for? How does it approximate an analog signal?
        low-pass filter
        electronic, mechanical (motor or speaker), others (human eye)
        
    (figure of PWM representing sinewave)
    \begin{figure}[]
        \centering\includegraphics[width=\textwidth]{pwm_sine}
        \caption{PWM approximation of an analog sine-wave.}
        \label{pwm_sine}
    \end{figure}
    
    How the STM32F0 generates PWM (fancier form of output compare)
    Perhaps in list mode where the registers involved are listed with their function?
    (figure of edge-aligned mode/sawtooth with appropriate markings)
     \begin{figure}[]
        \centering\includegraphics[width=\textwidth]{pwm_pin}
        \caption{Edge-aligned PWM mode and output pin state.}
        \label{pwm_pin}
    \end{figure}

\section{Configuring GPIO pins to Alternate Function Mode}
    What is Alternate Function Mode?
    Need to tell the GPIO hardware to allow the timer to directly control the pin output state
    Connecting a pin to an internal peripheral of the device is called "Alternate Function Mode"
    In the STM32F0s most peripherals are directly connected to specific sets of pins. 
        While you can't assign an internal signal to an arbitrary pin, they do give you a few pin options to choose.
        Most GPIO pins have multiple possible alternate functions, need to look up. 
    
    Use chip datasheet (Pinouts and pin descriptions section)
    
    \subsection{Finding Available Pins on a Device Package}
    Using a 64-pin LQFP (LQFP64)
    Table 13. STM32F072x8/xB pin definitions
    Only have pins that have physical pin numbers under the LQFP64 column. Table lists pin assignments for all chip packages the STM32F072 device is produced in.
    Alternate functions listed, will be talking about other columns of table in later labs.
    
    (marked Figure of table 13, package column highlighted, pin name and possible alternate functions)
    \begin{figure}[]
        \centering\includegraphics[width=0.8\textwidth]{chip_pins}
        \caption{Subset of table 13 - STM32F072x8/xB Datasheet}
        \label{chip_pins}
    \end{figure}

    \begin{example}[Finding Pins With an Alternate Function]
            Example: Chose arbitrary alternate function for a peripheral and walk through the process of finding pins
    \end{example}
    (add in section on how to graphically do this with stmcube later)
    
    \subsection{Selecting an Alternate Function}
    Demonstrate the AFR registers in the GPIO peripheral
    Once have pins that can use the AF, need to find what specific AF number it is for that pin.
    Use tables 14-19 in the chip datasheet
    
    (marked figure of table 14-19, pick a GPIO and an alternate function) 
    \begin{figure}[]
        \centering\includegraphics[width=\textwidth]{func_pins}
        \caption{Subset of table 15 - STM32F072x8/xB Datasheet}
        \label{func_pins}
    \end{figure}
   	
    \begin{example}[Determining an Alternate Function's Number] 
         Example: Find AF number and select for pin in previous example.
    \end{example}
    
\section{Lab Assignment:}



\end{document}
